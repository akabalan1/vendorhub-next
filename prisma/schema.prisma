// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ----- Enums -----

enum Role {
  VIEWER
  CONTRIBUTOR
  ADMIN
}

enum ServiceOption {
  WHITE_GLOVE
  CROWD_SOURCED
  FTE
}

enum ChallengeType {
  AUTH
  REG
}

// ----- Core models -----

model Vendor {
  id                 String          @id @default(cuid())
  name               String          @unique
  overview           String?
  website            String?
  country            String?
  regions            String[]        @db.Text
  platforms          String[]        @db.Text
  industries         String[]        @db.Text
  serviceOptions     ServiceOption[] @default([])

  // New: one descriptive field (not a rating)
  raterTrainingSpeed String?

  status     String   @default("active")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  costTiers  CostTier[]
  caps       VendorCapability[]
  feedback   Feedback[]

  @@index([name])
  @@index([status])
}

model Capability {
  id      String @id @default(cuid())
  slug    String @unique
  name    String
  desc    String?
  vendors VendorCapability[]
}

model VendorCapability {
  vendor   Vendor     @relation(fields: [vendorId], references: [id])
  vendorId String
  cap      Capability @relation(fields: [capId], references: [id])
  capId    String

  @@id([vendorId, capId])
}

model CostTier {
  id           String  @id @default(cuid())
  vendor       Vendor  @relation(fields: [vendorId], references: [id])
  vendorId     String
  tierLabel    String
  hourlyUsdMin Float?
  hourlyUsdMax Float?
  currency     String  @default("USD")
  notes        String?

  @@index([vendorId, tierLabel])
}

model Feedback {
  id            String   @id @default(cuid())
  vendor        Vendor   @relation(fields: [vendorId], references: [id])
  vendorId      String
  author        String?
  ratingQuality Int?
  ratingSpeed   Int?
  ratingComm    Int?
  text          String?
  tags          String[] @db.Text
  link          String?
  isPrivate     Boolean  @default(false)
  createdAt     DateTime @default(now())
}

model User {
  id             String    @id @default(cuid())
  name           String?
  email          String?   @unique
  emailVerified  DateTime?
  image          String?

  // Custom RBAC flag
  isAdmin        Boolean   @default(false)
}

model Passkey {
  id           String   @id @default(cuid())
  email        String
  credentialId String   @unique
  publicKey    String
  counter      Int
  transports   String[] @db.Text

  @@index([email])
}

model WebAuthnChallenge {
  id        String        @id @default(cuid())
  email     String
  type      ChallengeType
  challenge String
  expiresAt DateTime

  @@unique([email, type])
  @@index([expiresAt])
}

